global
    log stdout local0 info
    maxconn 4096
    daemon
    tune.ssl.default-dh-param 2048
    # stats socket /dev/null mode 600 level admin expose-fd listeners
    ssl-default-bind-options no-sslv3 no-tlsv10 no-tlsv11

defaults
    mode http
    timeout connect 5000
    timeout client  50000
    timeout server  50000
    option httplog
    option dontlognull
    option forwardfor
    option http-server-close

# Interface statistiques HAProxy
listen stats
    bind *:1936
    stats enable
    stats uri /
    stats refresh 10s
    stats auth admin:admin

# Frontend principal avec ports configurables
frontend main
    # Configuration des ports d'écoute - utilise des variables d'environnement
    # Par défaut: 8080 pour HTTP et 8443 pour HTTPS (évite les conflits avec Nginx)
    bind *:8080
    bind *:8443 ssl crt /usr/local/etc/haproxy/certs/cert.pem
    
    # Ajout des en-têtes
    http-request set-header X-Forwarded-Proto https if { ssl_fc }
    http-request set-header X-Forwarded-Proto http if !{ ssl_fc }
    http-request set-header X-Forwarded-Port 8443 if { ssl_fc }
    http-request set-header X-Forwarded-Port 8080 if !{ ssl_fc }
    
    # Redirection HTTP vers HTTPS
    redirect scheme https code 301 if !{ ssl_fc }
    
    # Définition des ACLs
    acl is_admin path_beg /admin
    acl is_static path_beg /static
    acl is_api path_beg /api
    acl is_ai_assistant path_beg /api/ai
    acl is_swagger path_beg /swagger
    acl is_redoc path_beg /redoc
    acl is_react path_beg /react
    acl is_netdata path_beg /netdata
    acl is_grafana path_beg /grafana
    acl is_prometheus path_beg /prometheus
    acl is_kibana path_beg /kibana
    
    # Routage vers services (priorité AI Assistant)
    use_backend ai-assistant-servers if is_ai_assistant or is_swagger or is_redoc
    use_backend react-servers if is_react
    use_backend django-servers if is_admin or is_static or is_api
    use_backend netdata-servers if is_netdata
    use_backend grafana-servers if is_grafana
    use_backend prometheus-servers if is_prometheus
    use_backend kibana-servers if is_kibana
    default_backend django-servers

# Backend pour AI Assistant (priorité haute)
backend ai-assistant-servers
    balance roundrobin
    option httpchk GET /admin/login/
    http-request set-header Host localhost:8000
    http-request set-header X-Forwarded-Host %[req.hdr(Host)]
    http-request set-header X-Forwarded-Proto https
    http-request set-header X-Forwarded-Port 8443
    http-request set-header X-Forwarded-For %[src]
    http-request set-header X-Forwarded-Ssl on
    http-request set-header X-Url-Scheme https
    server ai-assistant1 172.17.0.1:8000 check inter 3s rise 2 fall 2 weight 100 ssl verify none

# Backend pour React Frontend
backend react-servers
    mode http
    option forwardfor
    http-request set-header X-Forwarded-Proto https
    http-request set-header X-Forwarded-Port 8443
    server react1 172.17.0.1:5173 check inter 5s rise 2 fall 3

# Backend pour Django
backend django-servers
    balance roundrobin
    option httpchk HEAD /admin/login/
    http-request set-header Host localhost:8000
    http-request set-header X-Forwarded-Host %[req.hdr(Host)]
    http-request set-header X-Forwarded-Proto https
    http-request set-header X-Forwarded-Port 8443
    http-request set-header X-Forwarded-For %[src]
    http-request set-header X-Forwarded-Ssl on
    http-request set-header X-Url-Scheme https
    server django1 nms-django:8000 check inter 5s rise 2 fall 3 weight 100 ssl verify none

# Backend pour Netdata
backend netdata-servers
    mode http
    option forwardfor
    http-request set-header X-Forwarded-Proto http
    server netdata1 nms-netdata:19999 check resolvers dns init-addr none

# Backend pour Kibana
backend kibana-servers
    mode http
    option forwardfor
    http-request set-header X-Forwarded-Proto http
    server kibana1 nms-kibana:5601 check resolvers dns init-addr none

# Backend pour Prometheus
backend prometheus-servers
    mode http
    option forwardfor
    http-request set-header X-Forwarded-Proto http
    server prometheus1 nms-prometheus:9090 check resolvers dns init-addr none

# Backend pour Grafana
backend grafana-servers
    mode http
    option forwardfor
    http-request set-header X-Forwarded-Proto http
    server grafana1 nms-grafana:3000 check resolvers dns init-addr none

# Configuration des résolveurs DNS
resolvers dns
    nameserver dns1 127.0.0.11:53
    resolve_retries 3
    timeout retry 1s
    hold valid 10s

