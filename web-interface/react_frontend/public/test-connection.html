<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Connexion Frontend â†” Backend</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        button { 
            margin: 5px; 
            padding: 10px; 
            border: 1px solid #ddd;
            background: #f9f9f9;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover { 
            background: #e9e9e9; 
        }
        button:active { 
            background: #d9d9d9; 
        }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ”— Test Connexion Frontend â†” Backend</h1>
    
    <div class="test-section">
        <h2>Configuration actuelle</h2>
        <div id="config"></div>
    </div>
    
    <div class="test-section">
        <h2>Tests de connexion</h2>
        <button onclick="testJavaScript()">ğŸ§ª Test JavaScript</button>
        <button onclick="testAllEndpoints()">ğŸš€ Tester tous les endpoints</button>
        <button onclick="testConversations()">ğŸ’¬ Test Conversations</button>
        <button onclick="testCommands()">âš¡ Test Commands</button>
        <button onclick="testDocuments()">ğŸ“„ Test Documents</button>
        <button onclick="testSearch()">ğŸ” Test Search</button>
        <button onclick="clearResults()">ğŸ—‘ï¸ Effacer</button>
    </div>
    
    <div class="test-section">
        <h2>RÃ©sultats des tests</h2>
        <div id="results"></div>
    </div>

    <script>
        // Configuration API (utilise le proxy Vite)
        const API_CONFIG = {
            baseURL: '/api/ai',
            username: 'admin',
            password: 'admin'
        };

        // Afficher la configuration
        document.getElementById('config').innerHTML = `
            <strong>API URL:</strong> ${API_CONFIG.baseURL}<br>
            <strong>Username:</strong> ${API_CONFIG.username}<br>
            <strong>Frontend:</strong> ${window.location.origin}
        `;

        // Fonction pour rÃ©cupÃ©rer un cookie
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Test JavaScript
        function testJavaScript() {
            console.log('ğŸ§ª Test JavaScript dÃ©marrÃ©');
            const results = document.getElementById('results');
            results.innerHTML = `
                <div style="color: blue; padding: 10px; border: 1px solid blue; margin: 10px 0;">
                    <h3>ğŸ§ª Test JavaScript</h3>
                    <p>âœ… JavaScript fonctionne correctement !</p>
                    <p>ğŸ“… Timestamp: ${new Date().toISOString()}</p>
                    <p>ğŸŒ User Agent: ${navigator.userAgent}</p>
                    <p>ğŸ“ URL actuelle: ${window.location.href}</p>
                </div>
            `;
            alert('ğŸ§ª JavaScript fonctionne ! Regardez les rÃ©sultats ci-dessous.');
        }

        // Fonction de test gÃ©nÃ©rique
        async function testAPI(endpoint, method = 'GET', data = null, description = '') {
            const startTime = Date.now();
            const credentials = btoa(`${API_CONFIG.username}:${API_CONFIG.password}`);
            
            const resultDiv = document.createElement('div');
            resultDiv.innerHTML = `<h3>ğŸ”„ Test: ${description || endpoint}</h3>`;
            document.getElementById('results').appendChild(resultDiv);
            
            try {
                const url = `${API_CONFIG.baseURL}/${endpoint}`;
                console.log(`ğŸ”— Tentative de connexion Ã : ${url}`);
                
                // Headers pour la requÃªte
                const headers = {
                    'Authorization': `Basic ${credentials}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                };
                
                // Pour les requÃªtes POST, ajouter les headers CSRF et autres
                if (method === 'POST') {
                    headers['X-Requested-With'] = 'XMLHttpRequest';
                    // Essayer de rÃ©cupÃ©rer le CSRF token des cookies
                    const csrfToken = getCookie('csrftoken');
                    if (csrfToken) {
                        headers['X-CSRFToken'] = csrfToken;
                    }
                }
                
                console.log(`ğŸ“‹ Method: ${method}, Headers:`, headers);
                
                const response = await fetch(url, {
                    method: method,
                    headers: headers,
                    body: data ? JSON.stringify(data) : null,
                    credentials: 'include', // Inclure les cookies pour CSRF
                });
                
                const responseTime = Date.now() - startTime;
                const result = await response.text();
                let parsedResult;
                
                try {
                    parsedResult = JSON.parse(result);
                } catch (e) {
                    parsedResult = result;
                }
                
                if (response.ok) {
                    resultDiv.innerHTML += `
                        <div class="success">
                            âœ… <strong>SUCCÃˆS</strong> (${response.status}) - ${responseTime}ms<br>
                            <strong>URL:</strong> ${url}<br>
                            <strong>Response:</strong>
                            <pre>${JSON.stringify(parsedResult, null, 2)}</pre>
                        </div>
                    `;
                    return { success: true, data: parsedResult, status: response.status };
                } else {
                    resultDiv.innerHTML += `
                        <div class="error">
                            âŒ <strong>ERREUR HTTP</strong> (${response.status}) - ${responseTime}ms<br>
                            <strong>URL:</strong> ${url}<br>
                            <strong>Response:</strong>
                            <pre>${JSON.stringify(parsedResult, null, 2)}</pre>
                        </div>
                    `;
                    return { success: false, error: `HTTP ${response.status}`, data: parsedResult };
                }
                
            } catch (error) {
                const responseTime = Date.now() - startTime;
                console.error('âŒ Erreur de connexion:', error);
                
                resultDiv.innerHTML += `
                    <div class="error">
                        âŒ <strong>ERREUR DE CONNEXION</strong> - ${responseTime}ms<br>
                        <strong>URL:</strong> ${API_CONFIG.baseURL}/${endpoint}<br>
                        <strong>Erreur:</strong> ${error.message}<br>
                        <strong>Type:</strong> ${error.name}
                    </div>
                `;
                
                // Diagnostics spÃ©cifiques
                if (error.message.includes('CORS')) {
                    resultDiv.innerHTML += `
                        <div class="warning">
                            âš ï¸ <strong>ProblÃ¨me CORS dÃ©tectÃ©</strong><br>
                            Le backend doit autoriser les requÃªtes depuis ${window.location.origin}
                        </div>
                    `;
                }
                
                if (error.message.includes('certificate') || error.message.includes('SSL')) {
                    resultDiv.innerHTML += `
                        <div class="warning">
                            âš ï¸ <strong>ProblÃ¨me SSL dÃ©tectÃ©</strong><br>
                            Certificat auto-signÃ© rejetÃ© par le navigateur
                        </div>
                    `;
                }
                
                return { success: false, error: error.message };
            }
        }

        // Tests spÃ©cifiques
        async function testConversations() {
            await testAPI('conversations/', 'GET', null, 'Liste des conversations');
        }

        async function testCommands() {
            await testAPI('commands/', 'GET', null, 'Liste des commandes');
        }

        async function testDocuments() {
            await testAPI('documents/', 'GET', null, 'Liste des documents');
        }

        async function testSearch() {
            await testAPI('search/?q=test', 'GET', null, 'Recherche globale');
        }

        async function testCreateConversation() {
            const data = {
                title: 'Test Frontend Connection',
                metadata: { source: 'frontend_test', timestamp: new Date().toISOString() }
            };
            await testAPI('conversations/', 'POST', data, 'CrÃ©ation conversation');
        }

        async function testExecuteCommand() {
            const data = {
                name: 'test_frontend_connection',
                parameters: { source: 'frontend', timestamp: new Date().toISOString() }
            };
            await testAPI('commands/', 'POST', data, 'ExÃ©cution commande');
        }

        // Fonction pour obtenir le CSRF token
        async function getCSRFToken() {
            try {
                const response = await fetch('/api/ai/conversations/', {
                    method: 'GET',
                    credentials: 'include'
                });
                console.log('ğŸ” CSRF Token rÃ©cupÃ©rÃ© via cookies:', getCookie('csrftoken'));
                return getCookie('csrftoken');
            } catch (error) {
                console.log('âš ï¸ Impossible de rÃ©cupÃ©rer CSRF token:', error);
                return null;
            }
        }

        // Test complet
        async function testAllEndpoints() {
            clearResults();
            console.log('ğŸš€ DÃ©but des tests de connexion...');
            
            // Essayer de rÃ©cupÃ©rer le CSRF token d'abord
            await getCSRFToken();
            
            const tests = [
                () => testConversations(),
                () => testCommands(),
                () => testDocuments(),
                () => testSearch(),
                () => testCreateConversation(),
                () => testExecuteCommand()
            ];
            
            for (let i = 0; i < tests.length; i++) {
                console.log(`ğŸ“‹ Test ${i + 1}/${tests.length}`);
                await tests[i]();
                await new Promise(resolve => setTimeout(resolve, 500)); // Pause entre tests
            }
            
            console.log('âœ… Tests terminÃ©s');
        }

        function clearResults() {
            console.log('ğŸ—‘ï¸ Tentative d\'effacement des rÃ©sultats...');
            const resultsElement = document.getElementById('results');
            
            if (resultsElement) {
                resultsElement.innerHTML = '';
                console.log('âœ… RÃ©sultats effacÃ©s avec succÃ¨s');
                
                // Afficher une confirmation visuelle
                resultsElement.innerHTML = '<div style="color: green; padding: 10px; font-weight: bold;">ğŸ—‘ï¸ RÃ©sultats effacÃ©s !</div>';
                
                // Effacer la confirmation aprÃ¨s 2 secondes
                setTimeout(() => {
                    resultsElement.innerHTML = '';
                }, 2000);
            } else {
                console.error('âŒ Ã‰lÃ©ment "results" non trouvÃ© !');
            }
        }

        // Test automatique au chargement
        window.addEventListener('load', () => {
            console.log('ğŸ”— Page de test chargÃ©e');
            console.log('ğŸŒ Origine:', window.location.origin);
            console.log('ğŸ¯ API cible:', API_CONFIG.baseURL);
        });
    </script>
</body>
</html>