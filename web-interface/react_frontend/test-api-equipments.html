<!DOCTYPE html>
<html>
<head>
    <title>Test API √âquipements</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { background-color: #d4edda; }
        .error { background-color: #f8d7da; }
        .info { background-color: #e2f3ff; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Test API √âquipements - V√©rification du syst√®me unifi√©</h1>
    
    <div id="results"></div>
    
    <script>
        async function testApis() {
            const results = document.getElementById('results');
            
            try {
                // Test 1: API Network Devices (vraie source d'√©quipements)
                results.innerHTML += '<div class="test-section info"><h3>1. Test API Network Devices (/api/network/devices/)</h3><div id="test1">Chargement...</div></div>';
                
                const networkResponse = await fetch('http://localhost:8000/api/network/devices/', {
                    headers: {
                        'Authorization': 'Basic ' + btoa('admin@hybrido.com:hybrido2025')
                    }
                });
                
                if (networkResponse.ok) {
                    const networkDevices = await networkResponse.json();
                    const totalDevices = networkDevices.length;
                    const activeDevices = networkDevices.filter(d => d.is_active).length;
                    
                    document.getElementById('test1').innerHTML = `
                        <div class="success">
                            <strong>‚úÖ API Network Devices OK</strong><br>
                            Total √âquipements: <strong>${totalDevices}</strong><br>
                            √âquipements Actifs: <strong>${activeDevices}</strong><br>
                            <details>
                                <summary>D√©tails des √©quipements</summary>
                                <pre>${JSON.stringify(networkDevices, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                } else {
                    document.getElementById('test1').innerHTML = '<div class="error">‚ùå Erreur API Network Devices: ' + networkResponse.status + '</div>';
                }
                
                // Test 2: API GNS3 Projects (pour comparaison)
                results.innerHTML += '<div class="test-section info"><h3>2. Test API GNS3 Projects (/api/gns3/projects/)</h3><div id="test2">Chargement...</div></div>';
                
                const gns3Response = await fetch('http://localhost:8000/api/gns3/projects/', {
                    headers: {
                        'Authorization': 'Basic ' + btoa('admin@hybrido.com:hybrido2025')
                    }
                });
                
                if (gns3Response.ok) {
                    const gns3Projects = await gns3Response.json();
                    const totalProjects = gns3Projects.length;
                    const totalNodes = gns3Projects.reduce((acc, p) => acc + (p.nodes_count || 0), 0);
                    
                    document.getElementById('test2').innerHTML = `
                        <div class="success">
                            <strong>‚úÖ API GNS3 Projects OK</strong><br>
                            Total Projets: <strong>${totalProjects}</strong><br>
                            Total N≈ìuds GNS3: <strong>${totalNodes}</strong><br>
                            <details>
                                <summary>D√©tails des projets</summary>
                                <pre>${JSON.stringify(gns3Projects, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                } else {
                    document.getElementById('test2').innerHTML = '<div class="error">‚ùå Erreur API GNS3 Projects: ' + gns3Response.status + '</div>';
                }
                
                // Test 3: API Dashboard (pour v√©rifier totalEquipments)
                results.innerHTML += '<div class="test-section info"><h3>3. Test API Dashboard (/api/dashboard/)</h3><div id="test3">Chargement...</div></div>';
                
                const dashboardResponse = await fetch('http://localhost:8000/api/dashboard/', {
                    headers: {
                        'Authorization': 'Basic ' + btoa('admin@hybrido.com:hybrido2025')
                    }
                });
                
                if (dashboardResponse.ok) {
                    const dashboardData = await dashboardResponse.json();
                    
                    document.getElementById('test3').innerHTML = `
                        <div class="success">
                            <strong>‚úÖ API Dashboard OK</strong><br>
                            totalEquipments dans Dashboard: <strong>${dashboardData.totalEquipments || 'null'}</strong><br>
                            <details>
                                <summary>D√©tails dashboard</summary>
                                <pre>${JSON.stringify(dashboardData, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                } else {
                    document.getElementById('test3').innerHTML = '<div class="error">‚ùå Erreur API Dashboard: ' + dashboardResponse.status + '</div>';
                }
                
                // Conclusion
                results.innerHTML += `
                    <div class="test-section">
                        <h3>üéØ Conclusion et Recommandations</h3>
                        <div class="info">
                            <h4>Configuration Correcte pour totalEquipments:</h4>
                            <ul>
                                <li>‚úÖ Utiliser <strong>/api/network/devices/</strong> comme source principale</li>
                                <li>‚úÖ totalEquipments = nombre d'√©quipements r√©seau r√©els (${document.querySelector('#test1 strong:nth-child(2)')?.textContent || 'N/A'})</li>
                                <li>‚úÖ activeEquipments = √©quipements avec is_active=true</li>
                                <li>‚ö†Ô∏è Les n≈ìuds GNS3 sont s√©par√©s et ne doivent pas √™tre compt√©s dans totalEquipments</li>
                            </ul>
                            <p><strong>Le syst√®me UnifiedApiSystem.js doit utiliser networkDevices.data.totalDevices au lieu de gns3Projects.data.totalNodes</strong></p>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                results.innerHTML += '<div class="test-section error"><h3>‚ùå Erreur g√©n√©rale</h3><pre>' + error.message + '</pre></div>';
            }
        }
        
        // Lancer les tests au chargement
        window.onload = testApis;
    </script>
</body>
</html>